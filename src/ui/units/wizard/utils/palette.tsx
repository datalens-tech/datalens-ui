import React from 'react';

import type {SelectOption, SelectOptionGroup} from '@gravity-ui/uikit';
import {Text, spacing} from '@gravity-ui/uikit';
import AutogeneratedPaletteIcon from 'components/AutogeneratedPaletteIcon/AutogeneratedPaletteIcon';
import {i18n} from 'i18n';
import type {
    ColorPalette,
    Gradient,
    GradientPalettes,
    GradientType,
    InternalPaletteId,
    Palette,
    Palettes,
} from 'shared';
import {getPalettesOrder} from 'shared';
import {
    getAvailableClientPalettesMap,
    getDefaultColorPaletteId,
    getTenantDefaultColorPaletteId,
    selectAvailableClientPalettes,
} from 'ui';

import {PaletteIcon, PaletteType} from '../components/PaletteIcon/PaletteIcon';

export const getDefaultColorPalette = ({colorPalettes}: {colorPalettes?: ColorPalette[]}) => {
    const tenantDefaultColorPaletteId = getTenantDefaultColorPaletteId();
    const customPalette = colorPalettes?.find(
        (p) => p.colorPaletteId === tenantDefaultColorPaletteId,
    );

    if (customPalette) {
        return customPalette;
    }

    const systemPalettes = getAvailableClientPalettesMap();
    const defaultColorPaletteId = getDefaultColorPaletteId();
    const systemPalette =
        systemPalettes[tenantDefaultColorPaletteId] ?? systemPalettes[defaultColorPaletteId];

    return systemPalette;
};

export const getDefaultPaletteLabel = (defaultColorPalette: ColorPalette | Palette) => {
    let defaultPaletteName: string;
    if ('displayName' in defaultColorPalette) {
        defaultPaletteName = defaultColorPalette.displayName;
    } else {
        defaultPaletteName = i18n(
            'wizard.palette',
            `label_${defaultColorPalette.id as InternalPaletteId}`,
        );
    }

    return (
        <React.Fragment>
            {i18n('wizard', `label_default`)}
            <Text color="secondary" className={spacing({ml: 1})}>
                {defaultPaletteName}
            </Text>
        </React.Fragment>
    );
};

export const getPaletteSelectorItems = ({
    colorPalettes = [],
    withAuto = false,
}: {
    colorPalettes?: ColorPalette[];
    withAuto?: boolean;
}): SelectOptionGroup<{icon: JSX.Element}>[] => {
    const availablePalettes = selectAvailableClientPalettes();
    const palettesOrder = getPalettesOrder();

    const result: SelectOptionGroup<{icon: JSX.Element}>[] = [];

    if (withAuto) {
        const defaultColorPalette = getDefaultColorPalette({colorPalettes});
        const icon =
            'colors' in defaultColorPalette ? (
                <AutogeneratedPaletteIcon
                    colors={defaultColorPalette.colors}
                    height="16px"
                    width="20px"
                />
            ) : (
                <PaletteIcon
                    paletteType={PaletteType.ColorPalette}
                    paletteId={defaultColorPalette.id}
                />
            );

        result.push({
            label: '',
            options: [
                {
                    data: {
                        icon,
                    },
                    content: getDefaultPaletteLabel(defaultColorPalette),
                    value: '',
                },
            ],
        });
    }

    result.push(
        ...palettesOrder.map(
            (paletteName: keyof Palettes): SelectOptionGroup<{icon: JSX.Element}> => {
                const palette = availablePalettes[paletteName];
                const options = palette.map(
                    (item: string): SelectOption<{icon: JSX.Element}> => ({
                        data: {
                            icon: (
                                <PaletteIcon
                                    paletteType={PaletteType.ColorPalette}
                                    paletteId={item}
                                />
                            ),
                        },
                        content: i18n('wizard.palette', `label_${item as InternalPaletteId}`),
                        value: item,
                        qa: item,
                    }),
                );

                return {
                    label: '',
                    options,
                };
            },
        ),
    );

    if (colorPalettes.length) {
        result.push({
            label: '',
            options: colorPalettes.map(
                (colorPalette): SelectOption<{icon: JSX.Element}> => ({
                    data: {
                        icon: (
                            <AutogeneratedPaletteIcon
                                colors={colorPalette.colors}
                                height="16px"
                                width="20px"
                            />
                        ),
                    },
                    content: colorPalette.displayName,
                    value: colorPalette.colorPaletteId,
                }),
            ),
        });
    }

    return result;
};

function mapGradientToSelectOption(gradient: Gradient) {
    return {
        data: {
            icon: (
                <AutogeneratedPaletteIcon
                    colors={gradient.colors}
                    isGradient={true}
                    height="16px"
                    width="20px"
                />
            ),
        },
        content: gradient.title || i18n('wizard', `label_${gradient.id as GradientType}`),
        value: gradient.id,
    };
}

export const getGradientSelectorItems = (
    gradients: GradientPalettes,
): SelectOptionGroup<{icon: JSX.Element}>[] => {
    const basePalettes: Gradient[] = [];
    const namedPalettes: Gradient[] = [];

    Object.values(gradients).forEach((item) => {
        if (item.title) {
            namedPalettes.push(item);
        } else {
            basePalettes.push(item);
        }
    });

    const result: SelectOptionGroup<{icon: JSX.Element}>[] = [];
    if (basePalettes.length) {
        result.push({
            label: '',
            options: basePalettes.map(mapGradientToSelectOption),
        });
    }

    if (namedPalettes.length) {
        result.push({
            label: '',
            options: namedPalettes.map(mapGradientToSelectOption),
        });
    }

    return result;
};
